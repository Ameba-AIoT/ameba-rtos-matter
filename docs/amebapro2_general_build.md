# Matter (previously CHIP) on AmebaZ2

- [Get Ameba SDK & Matter SDK](#get-ameba-sdk--matter-sdk)
- [Set Matter Build Environment](#set-matter-build-environment)
- [Set Ameba Build Environment](#set-ameba-build-environment)
- [Build CHIP library by GN and Final Firmware](#build-chip-library-by-gn-and-final-firmware)
- [Flash Image](#flash-image)

## Get Ameba SDK & Matter SDK

    Tested on Ubuntu 22.04 or above

Create and enter new directory

    mkdir dev
    cd dev

To check out this repository:

    Please obtain the amebapro2_sdk from Realtek

To check out Matter repository:

    git clone https://github.com/Ameba-AIoT/connectedhomeip.git

Make sure amebapro2_sdk and connectedhomeip are on the same directory level

    dev/
    ├── amebapro2_sdk
    └── connectedhomeip

## Set Matter Build Environment

    > Find more details to setup linux build environment
    > https://github.com/Ameba-AIoT/connectedhomeip/blob/master/docs/guides/BUILDING.md

    cd connectedhomeip

    git submodule sync

    git submodule update --init --recursive

    source scripts/bootstrap.sh

    source scripts/activate.sh

## Set Ameba Build Environment

Navigate to the `amebapro2_sdk` directory:

    cd amebapro2_sdk

    chmod u+x matter_setup.sh

    ./matter_setup.sh

## Build CHIP library by GN and Final Firmware

In this context, we will demostrate building of all-clusters-app.

### all-clusters-app

Navigate to the `GCC-RELEASE` directory:

    cd amebapro2_sdk/project/realtek_amebapro2_v0_example/GCC-RELEASE

    make all_clusters

#### CHIP core (generated by GN/ninja in connectedhomeip. Configured by lib_chip.mk)

    output : amebapro2_sdk/project/realtek_amebapro2_v0_example/GCC-RELEASE/application/output

    > libCHIP.a

#### CHIP application (generated and configured by lib_chip_main.mk))

    output : amebapro2_sdk/project/realtek_amebapro2_v0_example/GCC-RELEASE/application/output

    > lib_main.a

### Make Ameba Matter application

**Please open a NEW terminal!!!!**

First, export amebapro2 toolchain:

```
    export amebapro2 toolchain

    tar -jxvf toolchain.tar.bz2

    export PATH=/opt/rtk-toolchain/asdk-10.3.0/linux/newlib/bin:$PATH
```

Now let's build the firmware:
```
    cd amebapro2_sdk/project/realtek_amebapro2_v0_example/GCC-RELEASE

    mkdir build_matter ; cd build_matter

    cmake .. -G"Unix Makefiles" -DCMAKE_TOOLCHAIN_FILE=../toolchain.cmake -DEXAMPLE=matter

    cmake --build . --target flash -j
```

### Clean Ameba Matter libraries

    make clean_matter_libs

