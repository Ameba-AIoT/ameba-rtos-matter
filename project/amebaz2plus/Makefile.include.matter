SHELL = /bin/bash
OS := $(shell uname)

# -------------------------------------------------------------------
# Directory Definition
# -------------------------------------------------------------------
# Root Directory and Main Paths
SDKROOTDIR           := $(shell pwd)/../../..
CHIPDIR              := $(SDKROOTDIR)/third_party/connectedhomeip
MATTER_DIR           := $(SDKROOTDIR)/component/common/application/matter

# Matter Subdirectories
MATTER_BUILD_DIR     := $(MATTER_DIR)/project/amebaz2plus
MATTER_API_DIR       := $(MATTER_DIR)/api
MATTER_CORE_DIR      := $(MATTER_DIR)/core
MATTER_COMMON_DIR    := $(MATTER_DIR)/common
MATTER_DRIVER_DIR    := $(MATTER_DIR)/drivers
MATTER_EXAMPLE_DIR   := $(MATTER_DIR)/examples
MATTER_TOOL_DIR      := $(MATTER_DIR)/tools

# Networking and Security Directories
LWIP_DIR             := $(MATTER_COMMON_DIR)/lwip
MBEDTLS_DIR          := $(MATTER_COMMON_DIR)/mbedtls

MATTER_LWIP_DIR       = $(LWIP_DIR)
MATTER_MBEDTLS_DIR    = $(MBEDTLS_DIR)

# Build System Directories
MATTER_MAKE_DIR      := $(MATTER_BUILD_DIR)/make
MATTER_TOOLCHAIN_DIR := $(MATTER_TOOL_DIR)/toolchain

# -------------------------------------------------------------------
# Toolchain and Compilation Definition
# -------------------------------------------------------------------
MATTER_INCLUDE_TOOLCHAIN = $(MATTER_BUILD_DIR)/Makefile.include.toolchain

include $(MATTER_INCLUDE_TOOLCHAIN)

# -------------------------------------------------------------------
# Version control
# -------------------------------------------------------------------

FREERTOS_VERSION   = freertos_v10.0.1
LWIP_VERSION       = lwip_v2.1.2
MBEDTLS_VERSION    = mbedtls-2.28.1

# -------------------------------------------------------------------
# Compiler Flags
# -------------------------------------------------------------------

CPPFLAGS += -std=gnu++17
CPPFLAGS += -fno-rtti

CFLAGS += -DCONFIG_MATTER=1

# compiler warnings
CFLAGS += -Wno-deprecated-declarations
CFLAGS += -Wno-format
CFLAGS += -Wno-format-nonliteral
CFLAGS += -Wno-format-security
CFLAGS += -Wno-sign-compare
CFLAGS += -Wno-unused-function
CFLAGS += -Wno-unused-but-set-variable
CFLAGS += -Wno-unused-variable
CFLAGS += -Wno-unused-label
CFLAGS += -Wno-unused-parameter

# compiler warnings
CFLAGS += -DCHIP_DEVICE_LAYER_TARGET=Ameba
CFLAGS += -DCHIP_DEVICE_LAYER_NONE=0

# chip device configuration
CFLAGS += -DCHIP_SYSTEM_CONFIG_USE_ZEPHYR_NET_IF=0
CFLAGS += -DCHIP_SYSTEM_CONFIG_USE_BSD_IFADDRS=0
CFLAGS += -DCHIP_SYSTEM_CONFIG_USE_ZEPHYR_SOCKET_EXTENSIONS=0
CFLAGS += -DCHIP_SYSTEM_CONFIG_USE_LWIP=1
CFLAGS += -DCHIP_SYSTEM_CONFIG_USE_SOCKETS=0
CFLAGS += -DCHIP_SYSTEM_CONFIG_USE_NETWORK_FRAMEWORK=0
CFLAGS += -DCHIP_SYSTEM_CONFIG_POSIX_LOCKING=0

CFLAGS += -DCHIP_SHELL_MAX_TOKENS=11

CFLAGS += -DCHIP_DEVICE_CONFIG_ENABLE_CHIPOBLE=1
CFLAGS += -DINET_CONFIG_ENABLE_IPV4=0
CFLAGS += -DFD_SETSIZE=10
CFLAGS += -DLWIP_IPV6_ROUTE_TABLE_SUPPORT=1
CFLAGS += -DMBEDTLS_CONFIG_FILE=\"matter_mbedtls_config.h\"
CFLAGS += -DCHIP_HAVE_CONFIG_H

CFLAGS += -DCONFIG_BT=1
CFLAGS += -DCONFIG_MATTER_BLEMGR_ADAPTER=1

# Matter
CFLAGS += -DCONFIG_ENABLE_AMEBA_CRYPTO=0
CFLAGS += -DCONFIG_ENABLE_AMEBA_DCT_ENC=0
CFLAGS += -DCONFIG_ENABLE_AMEBA_FACTORY_DATA=0
CFLAGS += -DCONFIG_ENABLE_AMEBA_FACTORY_DATA_ENC=0
CFLAGS += -DCONFIG_ENABLE_AMEBA_PRNG=0
CFLAGS += -DCONFIG_ENABLE_AMEBA_SNTP=1
CFLAGS += -DCONFIG_ENABLE_AMEBA_TEST_EVENT_TRIGGER=0

# -------------------------------------------------------------------
# Matter Cluster Flags
# -------------------------------------------------------------------

# Access Control Cluster (Server) - Extension
CFLAGS += -DCHIP_CONFIG_ENABLE_ACL_EXTENSIONS=1

# Diagnostic Logs Cluster (Server)
ifeq ($(CHIP_ENABLE_AMEBA_DLOG), 1)
  CFLAGS += -DCHIP_CONFIG_ERROR_SOURCE=1
  CFLAGS += -DCHIP_CONFIG_ERROR_FORMAT_AS_STRING=1
  CFLAGS += -DCHIP_CONFIG_ENABLE_BDX_LOG_TRANSFER=1
endif

# OTA Requestor Cluster (Server)
CFLAGS += -DCONFIG_ENABLE_OTA_REQUESTOR=1
